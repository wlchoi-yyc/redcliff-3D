
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>赤壁之戰｜零建模 3D 場景（相容版）</title>
<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #app{position:fixed;inset:0}
  .hud{position:fixed;left:12px;top:12px;right:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;z-index:10}
  .hud .card{background:rgba(12,20,35,.65);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px;color:#d7e6ff}
  .btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;font-weight:600;background:#1f6feb;color:#fff;box-shadow:0 2px 8px rgba(31,111,235,.35);cursor:pointer}
  .btn.alt{background:#2ea043;box-shadow:0 2px 8px rgba(46,160,67,.35)}
  .btn.warn{background:#d29922;box-shadow:0 2px 8px rgba(210,153,34,.35)}
  .legend{font-size:12px;opacity:.9;line-height:1.4}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:10px;display:flex;justify-content:center;z-index:10;color:#a7b7d7;font-size:12px;pointer-events:none}
  #msg{position:fixed;inset:auto 12px 12px 12px;color:#ffcc66;font-size:12px}
</style>
</head>
<body>
<div id="app"></div>

<div class="hud">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">赤壁之戰 3D（教學示範）</div>
    <div class="legend">可旋轉/縮放/平移視角；切換風向觀察火攻差異。</div>
  </div>
  <button class="btn" id="windSE">東南風</button>
  <button class="btn alt" id="windNE">東北風</button>
  <button class="btn warn" id="resetCam">重置視角</button>
</div>
<div class="footer">操作：拖動=旋轉｜雙指=縮放｜兩指拖=平移</div>
<div id="msg"></div>

<!-- 非模組版 Three.js（相容性較高） -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

<script>
(function(){
  const msg = document.getElementById('msg');
  try {
    // WebGL 檢查
    const canvas = document.createElement('canvas');
    const ok = !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
    if(!ok){ msg.textContent = '你的裝置/瀏覽器未啟用 WebGL（請更新瀏覽器或關閉省電/低耗模式）'; return; }

    const app = document.getElementById('app');
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x0b1220, 0.03);

    scene.add(new THREE.AmbientLight(0xcbd5ff, 0.55));
    const sun = new THREE.DirectionalLight(0xffffff, 1.1);
    sun.position.set(2,3,2); sun.castShadow = true; scene.add(sun);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 200);
    camera.position.set(4,3,6);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    app.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.target.set(0,0.25,0);

    // 群組
    const group = new THREE.Group(); scene.add(group);

    // 江面
    const waterGeom = new THREE.PlaneGeometry(16,10,120,80);
    const waterMat = new THREE.MeshPhongMaterial({color:0x1d59ff, emissive:0x021023, shininess:80, transparent:true, opacity:0.95});
    const water = new THREE.Mesh(waterGeom, waterMat);
    water.rotation.x = -Math.PI/2; water.position.y = 0.0; water.receiveShadow = true; group.add(water);

    // 兩岸
    function makeCliff(w,h,d,x,z,rot, col){ 
      const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshPhongMaterial({color:col||0x6b5b53}));
      m.castShadow = m.receiveShadow = true; m.position.set(x,h/2,z); m.rotation.y = rot||0; return m;
    }
    group.add(makeCliff(16,0.4,5,-0.5,-3,0,0x6f645c), makeCliff(16,0.7,2,-0.5,-5.5,0,0x6a5a52));
    group.add(makeCliff(16,0.4,5,-0.5, 3,0,0x6f645c), makeCliff(16,0.7,2,-0.5, 5.5,0,0x6a5a52));

    function makeStrip(z){ const g=new THREE.PlaneGeometry(16,1); const m=new THREE.MeshBasicMaterial({color:0x2a8f62}); const mesh=new THREE.Mesh(g,m); mesh.rotation.x=-Math.PI/2; mesh.position.set(0,0.21,z); return mesh; }
    group.add(makeStrip(-2.5), makeStrip(2.5));

    function makeFireSprite(){
      const size=128, cnv=document.createElement('canvas'); cnv.width=cnv.height=size; const ctx=cnv.getContext('2d');
      const grd=ctx.createRadialGradient(size*0.5,size*0.6,5,size*0.5,size*0.6,size*0.48);
      grd.addColorStop(0,'rgba(255,240,180,1)'); grd.addColorStop(0.4,'rgba(255,140,40,0.95)'); grd.addColorStop(1,'rgba(255,80,0,0)');
      ctx.fillStyle=grd; ctx.fillRect(0,0,size,size);
      const tex=new THREE.Texture(cnv); tex.needsUpdate=true;
      const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true,depthWrite:false}));
      spr.scale.set(0.5,0.7,1); spr.userData.isFlame=true; return spr;
    }
    function makeSmoke(){
      const grp=new THREE.Group();
      for(let i=0;i<6;i++){ const s=0.12+Math.random()*0.15;
        const m=new THREE.Mesh(new THREE.SphereGeometry(s,12,10),new THREE.MeshPhongMaterial({color:0x888888,transparent:true,opacity:0.35}));
        m.position.set((Math.random()-0.5)*0.15,i*0.12,(Math.random()-0.5)*0.12); grp.add(m);
      }
      grp.userData.isSmoke=true; return grp;
    }
    function makeShip(opt){
      const color=(opt&&opt.color)||0x8b3a2a, sailColor=(opt&&opt.sailColor)||0xfff7de;
      const ship=new THREE.Group();
      const hull=new THREE.Mesh(new THREE.BoxGeometry(1.2,0.2,0.35), new THREE.MeshPhongMaterial({color})); hull.castShadow=hull.receiveShadow=true; hull.position.y=0.12; ship.add(hull);
      const prow=new THREE.Mesh(new THREE.ConeGeometry(0.18,0.3,4), new THREE.MeshPhongMaterial({color})); prow.rotation.z=Math.PI/2; prow.position.set(0.65,0.15,0); ship.add(prow);
      const stern=new THREE.Mesh(new THREE.ConeGeometry(0.12,0.25,4), new THREE.MeshPhongMaterial({color})); stern.rotation.z=-Math.PI/2; stern.position.set(-0.65,0.17,0); ship.add(stern);
      const mast=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.8,12), new THREE.MeshPhongMaterial({color:0x5c4a3c})); mast.position.set(0.1,0.55,0); mast.castShadow=true; ship.add(mast);
      const sail=new THREE.Mesh(new THREE.PlaneGeometry(0.9,0.6,10,6), new THREE.MeshPhongMaterial({color:sailColor,side:THREE.DoubleSide,transparent:true,opacity:0.95}));
      sail.position.set(0.35,0.55,0); sail.rotation.y=Math.PI/16; sail.castShadow=true; ship.add(sail);
      const flag=new THREE.Mesh(new THREE.PlaneGeometry(0.28,0.18,8,1), new THREE.MeshPhongMaterial({color: color===0x8b3a2a?0xd93f3f:0x2e6fe5, side:THREE.DoubleSide}));
      flag.position.set(0.1,0.9,-0.1); ship.add(flag);
      if(opt&&opt.fire){ const flame=makeFireSprite(); flame.position.set(0.3,0.2,0); ship.add(flame); const smoke=makeSmoke(); smoke.position.set(0.3,0.28,0); ship.add(smoke); }
      return ship;
    }

    const ships=new THREE.Group(); group.add(ships);
    function addShip(x,z,rot,opt){ const s=makeShip(opt); s.position.set(x,0.02,z); s.rotation.y=rot||0; ships.add(s); return s; }

    addShip( 2.8,-0.6,  Math.PI*0.02,{color:0x8b3a2a,sailColor:0xfff0cc});
    addShip( 2.2, 0.3, -Math.PI*0.05,{color:0x8b3a2a,sailColor:0xfff0cc});
    addShip( 2.4,-0.1, -Math.PI*0.04,{color:0x8b3a2a,sailColor:0xffebbb,fire:true});

    for(let i=0;i<5;i++){
      addShip(-2.8+i*0.5, -0.2+Math.sin(i)*0.12, Math.PI*0.02, {color:0x5b341f,sailColor:0xe4ecff});
      const link=new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.5,8), new THREE.MeshPhongMaterial({color:0x777777}));
      link.rotation.z=Math.PI/2; link.position.set(-2.55+i*0.5,0.15,-0.2+Math.sin(i)*0.12); ships.add(link);
    }

    function makeLabel(text){
      const w=400,h=120, cnv=document.createElement('canvas'); cnv.width=w; cnv.height=h; const ctx=cnv.getContext('2d');
      ctx.fillStyle="rgba(12,20,35,.65)"; ctx.fillRect(0,0,w,h); ctx.strokeStyle="rgba(255,255,255,.2)"; ctx.strokeRect(0,0,w,h);
      ctx.fillStyle="#d7e6ff"; ctx.font="bold 48px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(text,w/2,h/2);
      const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.Texture(cnv),transparent:true})); spr.material.map.needsUpdate=true; spr.scale.set(1.6,0.48,1); return spr;
    }
    const lblCao=makeLabel("曹軍 連環船列"); lblCao.position.set(-2.1,1.1,-0.7); scene.add(lblCao);
    const lblZhou=makeLabel("周瑜／黃蓋 火攻"); lblZhou.position.set( 2.1,1.1, 0.7); scene.add(lblZhou);

    let wind=new THREE.Vector3(-0.6,0.0,0.15);
    const WIND_SE=new THREE.Vector3(-0.6,0.0,0.15), WIND_NE=new THREE.Vector3(0.5,0.0,-0.15);

    document.getElementById('windSE').onclick=()=>wind.copy(WIND_SE);
    document.getElementById('windNE').onclick=()=>wind.copy(WIND_NE);
    document.getElementById('resetCam').onclick=()=>{ camera.position.set(4,3,6); controls.target.set(0,0.25,0); controls.update(); };

    const pos=water.geometry.attributes.position, basePos=pos.array.slice();
    function animateWater(t){
      for(let i=0;i<pos.count;i++){ const ix=i*3, x=basePos[ix], y=basePos[ix+1];
        pos.array[ix+2]= Math.sin(x*0.8+t*0.0018)*0.06 + Math.sin(y*1.2+t*0.0012)*0.04;
      } pos.needsUpdate=true;
    }
    function animateShips(t){
      ships.children.forEach(obj=>{
        if(obj.type==='Group'){
          obj.position.y = 0.02 + Math.sin(t*0.001+obj.id)*0.005;
          obj.children.forEach(c=>{
            if(c.geometry && c.geometry.type==='PlaneGeometry' && !c.userData.isFlame){
              const targetRot=Math.atan2(wind.z,-wind.x)*0.15; c.rotation.y += (targetRot - c.rotation.y)*0.05;
            }
            if(c.userData?.isFlame){ c.scale.y = 0.6 + Math.sin(t*0.02 + c.id)*0.2; c.position.x += wind.x*0.002; c.position.z += wind.z*0.002; }
            if(c.userData?.isSmoke){ c.children.forEach(s=>{ s.position.x += wind.x*0.003; s.position.z += wind.z*0.003; s.material.opacity = 0.25 + 0.1*Math.sin(t*0.001 + s.id); }); }
          });
        }
      });
    }

    addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });

    (function loop(t){
      animateWater(performance.now());
      animateShips(performance.now());
      controls.update();
      renderer.render(scene,camera);
      requestAnimationFrame(loop);
    })();

  } catch(e){
    console.error(e);
    msg.textContent = '初始化失敗：' + (e.message||e);
  }
})();
</script>
</body>
</html>
